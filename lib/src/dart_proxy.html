<script>
    var ProxyLib = ProxyLib || {};

    (function(ProxyLib) {

        ProxyLib.createDartTypeProxy = function(factory) {

            var prot = factory();
            var p =  new Proxy(function(){},{

                'construct' : function(target,args,newTarget) {
                  return factory();
                },
                'get' : function(target,propertyName) {
                  if (propertyName=='prototype') {
                    console.log("Doing proto");
                    return prot;
                  } else {
                    return target[propertyName];
                  }
                },
                'set' : function(target,propertyName,val) {
                  if (propertyName=='prototype') {
                    prot = val;
                  } else {
                    target[propertyName] = val;
                  }
                }
            });

            p.prototype=new p();

            return p;


        }

    })(ProxyLib);


    ProxyLib.Basic = {};

    (function(ES6) {

      ES6.Unsupported = {};

      var _throwShouldBeOverridden = function() {
        throw new Error("This method should be overridden by dart implementation");
      };

      ES6._dartArrayGet = _throwShouldBeOverridden;
      ES6._dartArrayPut = _throwShouldBeOverridden;
      ES6._dartArrayLength = _throwShouldBeOverridden;

      ES6._dartGet = _throwShouldBeOverridden;
      ES6._dartPut = _throwShouldBeOverridden;
      ES6._dartKeys = _throwShouldBeOverridden;

      /**
       * List ES6JsProxy support
       */

      var arrayCommonBehaviors = {
        '__dartClass__' : function(instance) { return instance; },
        '__isES6Proxy__' : function(instance) { return true; },

        'length' : function(instance) { return ES6._dartArrayLength(instance); }
      };

      // TODO(dam0vment) investigate if overriding only get/setOwnPropertyDescriptor and ownKeys
      // is enough (all the other methods could just depend on those)
      ES6.createES6JsProxyForArray = function(instance) {
        return new Proxy([],{
          'get' : function(target,propertyName,proxy) {

            if (arrayCommonBehaviors.hasOwnProperty(propertyName)) {
              return arrayCommonBehaviors[propertyName].call(this,instance);
            }

            if (isNaN(propertyName.toString())) {
              return target[propertyName];
            }

            return ES6._dartArrayGet(instance,+propertyName);
          },

          'has' : function(target,prop) {
            var len = ES6._dartArrayLength(instance);
            var pos = +prop;
            if (!isNaN(prop) && pos>=0 && pos < len ) {
              return true;
            }
            return prop in target;
          },

          'getOwnPropertyDescriptor': function(target, prop) {
            var len = ES6._dartArrayLength(instance);
            var pos = +prop;
            if (!isNaN(prop) && pos>=0 && pos < len ) {
              return { configurable: true, enumerable: true, value: ES6._dartArrayGet(instance,pos) };
            }
            return Object.getOwnPropertyDescriptor(target,prop);
          },

          'set' : function(target,propertyName,value,proxy) {
            if (isNaN(propertyName.toString())) {
              target[propertyName] = value;
            } else {
              ES6._dartArrayPut(instance,+propertyName,value);
            }
            return true;
          },
          'ownKeys' : function(target) {
            var x = Object.getOwnPropertyNames(target).slice();
            for (var i = 0 ;i<ES6._dartArrayLength(instance);i++) {
              x.push(""+i);
            }
            return x;
          }
        });
      };


      /**
       * Maps ES6JsProxy support
       */

      var mapCommonBehaviors = {
        '__dartClass__' : function(instance) { return instance; },
        '__isES6Proxy__' : function(instance) { return true; }
      };

      ES6.createES6JsProxyForMaps = function(instance) {
        return new Proxy({},{
          'has' : function(target,prop){
            return ES6._dartKeys(instance).indexOf(prop) >= 0;
          },
          getOwnPropertyDescriptor: function(target, prop) {
            if (ES6._dartKeys(instance).indexOf(prop) >= 0) {
              return { configurable: true, enumerable: true, value: ES6._dartGet(instance,prop) };
            }
            return Object.getOwnPropertyDescriptor(target,prop);
          },

          'get' : function(target,propertyName,proxy) {

            // target first! (because of '__proto__' , 'constructor' , and dart interop internals ... )
            var _cache = target[propertyName];
            if(_cache) {
              return _cache;
            }

            if (mapCommonBehaviors.hasOwnProperty(propertyName)) {
              return mapCommonBehaviors[propertyName].call(this,instance);
            }

            return ES6._dartGet(instance,propertyName);
          },

          'set' : function(target,propertyName,value,proxy) {
            ES6._dartPut(instance,propertyName,value);
            return true;
          },

          'ownKeys' : function(target) {
            return Object.getOwnPropertyNames(target).concat(ES6._dartKeys(instance));
          }
        });
      };

    })(ProxyLib.Basic);


    ProxyLib.Objects = {};
    (function(ES6) {

      ES6.Unsupported = {};

      var _throwShouldBeOverridden = function() {
        throw new Error("This method should be overridden by dart implementation");
      };

      ES6._dartGetter = _throwShouldBeOverridden;
      ES6._dartSetter = _throwShouldBeOverridden;
      ES6._dartGetProperties = _throwShouldBeOverridden;


      /**
       * Object ES6JsProxy support
       */

      var commonBehaviors = {
        '__dartClass__' : function(instance) { return instance; },
        '__isES6Proxy__' : function(instance) { return true; }
      };

      ES6.createES6JsProxy = function(instance) {
        // Collect property names
        var _dartProperties = ES6._dartGetProperties(instance);
        var dartPropertySet = {};
        var dartMethodSet= {};
        _dartProperties.props.forEach(function(propertyName) {
          dartPropertySet[propertyName] = true;
        });

        _dartProperties.mets.forEach(function(propertyName) {
          dartPropertySet[propertyName] = true;
          dartMethodSet[propertyName] = true;
        });


        return new Proxy({},{
          'get' : function(target,propertyName,proxy) {

            if (commonBehaviors.hasOwnProperty(propertyName)) {
              return commonBehaviors[propertyName].call(this,instance);
            }

            if (dartPropertySet.hasOwnProperty(propertyName)) {
              return ES6._dartGetter(instance,propertyName);
            } else {
              return target[propertyName];
            }
          },
          'has' : function(target,prop) {
            return prop in dartPropertySet;
          },
          'set' : function(target,propertyName,value,proxy) {
            if (dartPropertySet.hasOwnProperty(propertyName)) {
              ES6._dartSetter(instance,propertyName,value);
            } else {
              target[propertyName] = value;
            }
            return true;
          },
          'ownKeys' : function(target) {
            return Object.getOwnPropertyNames(target).concat(Object.getOwnPropertyNames(dartPropertySet));
          },
          'getOwnPropertyDescriptor' : function(target,prop) {
            if (dartPropertySet.hasOwnProperty(prop)) {
              return  { configurable: true, enumerable:true, value: ES6._dartGetter(instance,prop) };
            } else {
              return Object.getOwnPropertyDescriptor(target,prop);
            }
          }
        });
      };

      ES6.createMethodInvoker = function(dartInvoker) {
        return function() {
          return dartInvoker(Array.prototype.slice.call(arguments));
        };
      };

    })(ProxyLib.Objects);


</script>
